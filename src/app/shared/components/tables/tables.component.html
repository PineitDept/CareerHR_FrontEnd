<!-- expandable-table.component.html -->
<div #tableWrapper class="tw-relative tw-bg-white tw-w-fit tw-min-w-full"
  [ngClass]="{
    'tw-pr-2': rowsValue.length > 0 && hasOverflowY,
    'tw-px-0 tw-py-0': withinCard,
    'tw-px-6 tw-py-6 tw-pt-0': !withinCard,
  }"
>
  <div class="tw-shadow-sm tw-border tw-border-gray-200"
    [ngClass]="withinCard ? '' : 'tw-overflow-clip tw-rounded-md'"
  >
    <table class="tw-table-fixed tw-w-full tw-text-sm tw-text-left tw-border-separate tw-border-spacing-0">
      <thead>
        <tr class="tw-text-white"
          [ngClass]="{
            'tw-text-white': !withinCard,
            'tw-text-black': withinCard,
            'tw-h-[45px]': withinCard,
          }"
        >
          <!-- Checkbox Column -->
          <th
            class="tw-w-[36px] tw-px-1 tw-py-2  tw-bg-clip-padding"
            *ngIf="showCheckbox"
            [ngClass]="{
              'tw-rounded-tl-md': !withinCard,
              'tw-bg-red-900': !withinCard,
              'tw-bg-[#F0F3F5]': withinCard,
              '!tw-rounded-tl-none': withinCard
            }"
          >
            <div class="tw-flex tw-text-center tw-align-middle">
              <input #selectAllCheckbox type="checkbox" [checked]="allSelected" (click)="$event.preventDefault()"
                (mousedown)="onHeaderCheckboxClick($event)"
                class="tw-accent-red-800 tw-w-5 tw-h-5 tw-mx-auto tw-cursor-pointer disabled:tw-cursor-not-allowed"
                [disabled]="rowsValue.length === 0" />
            </div>
          </th>

          <!-- Dynamic Columns with Smooth Animation -->
          <ng-container *ngFor="let column of columns; let first = first; let last = last; trackBy: trackByColumn">
            <th class="column-header tw-px-2 tw-py-2 tw-text-center tw-relative tw-whitespace-nowrap tw-bg-clip-padding"
              [class.main-column]="column.mainColumn" [class.sub-column]="column.subColumn"
              [class.wrap-text]="column.wrapText" [class.expanded]="!column.subColumn || isSubColumnVisible(column)"
              [class.collapsed]="column.subColumn && !isSubColumnVisible(column)" [style.width]="getColumnWidth(column)"
              [style.min-width]="getColumnMinWidth(column)" [style.max-width]="getColumnMaxWidth(column)"

              (click)="onColumnClick(column)"
              [ngClass]="{
                '!tw-rounded-tl-[4px]': first && !showCheckbox && !withinCard,
                '!tw-rounded-tr-[4px]': last && !withinCard,
                'tw-bg-red-900': !withinCard,
                'tw-bg-[#F0F3F5]': withinCard,
                '!tw-rounded-tl-none': withinCard && first && !showCheckbox,
                '!tw-rounded-tr-none': withinCard && last,
                'tw-border-b tw-border-gray-200': withinCard,
              }"
            >
              <div class="header-content tw-flex tw-items-center tw-justify-center tw-gap-2"
                [style.justify-content]="withinCard ? (column.align || 'left') : ''"
              >
                <!-- Sub-column indicator -->
                <span *ngIf="column.subColumn" class="tw-text-red-300 tw-font-mono tw-text-xs tw-opacity-75">â””</span>

                <!-- Column header text -->
                <span class="column-header-text tw-font-medium tw-truncate">{{ column.header }}</span>
                <!-- Sort Icon -->
                <app-icon *ngIf="column.sortable" [name]="
                  sortStateValue[column.field] === 'asc'
                    ? 'sort-down'
                    : sortStateValue[column.field] === 'desc'
                    ? 'sort-up'
                    : 'sort'
                  "
                  [size]="12" fill="currentColor"
                ></app-icon>
                <!-- Toggle button for main columns -->
                <button *ngIf="column.mainColumn && hasSubColumns(column.mainColumn)"
                  class="toggle-btn tw-ml-1 tw-p-1 tw-rounded tw-transition-all tw-duration-200 hover:tw-bg-red-800 tw-flex-shrink-0"
                  (click)="$event.stopPropagation(); toggleExpandRow(column.mainColumn, $event)" type="button"
                  [attr.aria-expanded]="expandedMainColumns.has(column.mainColumn)"
                  [attr.aria-label]="'Toggle ' + column.header + ' sub-columns'">
                  <app-icon name="sliders-horizontal-square" [size]="24" fill="currentColor"
                    [extraClass]="'tw-transition-transform tw-duration-300 tw-ease-in-out ' + (expandedMainColumns.has(column.mainColumn) ? 'tw-rotate-180' : '')">
                  </app-icon>
                </button>
              </div>
            </th>
          </ng-container>
        </tr>
      </thead>

      <!-- Table Body -->
      <tbody
        *ngIf="rowsValue.length > 0; else noData"
        cdkDropList
        [cdkDropListData]="rowsValue"
        [cdkDropListDisabled]="!draggableRows || isDisabledForm"
        (cdkDropListDropped)="onDrop($event)"
      >
        <tr *ngFor="let row of rowsValue; let i = index; trackBy: trackByRow"
          cdkDrag
          cdkDragLockAxis="y"
          class="table-row tw-transition-colors tw-duration-200 tw-cursor-pointer"
          [ngClass]="{
            'tw-cursor-pointer': enableRowClick,
            'tw-cursor-default': !enableRowClick,
            'tw-bg-red-50': rowValidationErrors[row._tempId ?? row.id]
          }"
          [class.tw-bg-white]="!splitRows"
          [class.tw-bg-gray-50]="splitRows && i % 2 === 0" [class.tw-bg-gray-100]="splitRows && i % 2 === 1"
          [class.hover:tw-bg-gray-200]="true" [class.tw-border-b]="i < rowsValue.length - 1 && !splitRows"
          [class.selected-row]="selectedRows.has(i)"
          [class.tw-bg-yellow-50]="clickedRows.has(row.id?.toString())"
          [class.tw-bg-red-100]="ishighlightRow && highlightRowIndex === i"
          (click)="enableRowClick && onRowClick(row, $event)">

          <!-- Checkbox Cell -->
          <td class="tw-w-[36px] tw-px-1 tw-py-2" *ngIf="showCheckbox"
            [ngClass]="{
              'tw-rounded-bl-xl': withinCard && i === rowsValue.length - 1,
              'tw-border-b tw-border-gray-200': withinCard && i < rowsValue.length - 1
            }"
          >
            <div class="tw-flex tw-text-center tw-align-middle">
              <input type="checkbox" [checked]="selectedRows.has(i)" (change)="toggleSelectRow(i)"
                (click)="$event.stopPropagation()"
                class="tw-accent-red-800 tw-w-5 tw-h-5 tw-mx-auto tw-cursor-pointer" />
            </div>
          </td>

          <!-- Dynamic Data Cells -->
          <ng-container *ngFor="let column of columns; let firstCol = first; let lastCol = last; trackBy: trackByColumn">
            <td class="table-cell tw-px-2 tw-py-2 tw-align-middle"
              [class.main-column]="column.mainColumn" [class.sub-column]="column.subColumn"
              [class.wrap-text]="column.wrapText" [class.expanded]="!column.subColumn || isSubColumnVisible(column)"
              [class.collapsed]="column.subColumn && !isSubColumnVisible(column)" [style.width]="getColumnWidth(column)"
              [style.min-width]="getColumnMinWidth(column)" [style.max-width]="getColumnMaxWidth(column)"
              [style.text-align]="column.align || 'left'"
              [ngClass]="[
                column.type === 'icon' && !column.sortable ? getBackgroundClass(getCellValue(row, column.field)?.fill) : '',
                withinCard && i === rowsValue.length - 1 && !showCheckbox && firstCol ? 'tw-rounded-bl-xl' : '',
                withinCard && i === rowsValue.length - 1 && lastCol ? 'tw-rounded-br-xl' : '',
                (withinCard && i < rowsValue.length - 1) ? 'tw-border-b tw-border-gray-200' : '',
                isDisabledForm ? 'tw-bg-[#fafafa]': '',
                (isDisabledForm && !(column.type === 'textlink' && allowViewWhenDisabled)) ? 'tw-pointer-events-none' : '',
              ]"
            >
              <!-- Cell Content with Type Switching -->
              <div class="cell-content"
                [ngClass]="{
                  'tw-text-gray-600': isDisabledForm,
                  'tw-text-gray-800': !isDisabledForm
                }"
              >
                <ng-container [ngSwitch]="column.type || 'text'">

                  <!-- Text Content -->
                  <span *ngSwitchCase="'text'">
                    <!-- {{ getCellValue(row, column.field) }} -->

                    <!-- <ng-container *ngIf="editingRowId === i+1; else viewMode" >
                      <input
                        type="text"
                        class="tw-border tw-border-gray-300 tw-rounded tw-px-2 tw-py-1 tw-w-full"
                        [(ngModel)]="row[column.field]"
                        (click)="$event.stopPropagation()" />
                    </ng-container> -->
                    <ng-container *ngIf="editRow && (editingRowId === (row._tempId ?? i+1)) && (column.editing ?? true); else viewMode">
                      <input
                        type="text"
                        class="tw-border tw-rounded tw-px-2 tw-py-1 tw-w-full tw-bg-white"
                        [ngClass]="fieldErrors ? 'tw-border-red-500' : 'tw-border-gray-300'"
                        [(ngModel)]="editingBuffer[column.field]"
                        (click)="$event.stopPropagation()"
                      />
                    </ng-container>
                    <ng-template #viewMode>
                      {{ getCellValue(row, column.field) }}
                    </ng-template>
                  </span>

                  <!-- Expandable Content -->
                  <div *ngSwitchCase="'expandable'">
                    <span>{{ getCellValue(row, column.field) }}</span>
                  </div>

                  <!-- Badge Content -->
                  <span *ngSwitchCase="'badge'"
                    class="tw-inline-flex tw-items-center tw-justify-center tw-rounded-lg tw-px-2.5 tw-py-1 tw-text-xs tw-font-medium tw-ring-1 tw-ring-inset tw-transition-all tw-duration-200 tw-max-w-full tw-whitespace-nowrap tw-overflow-hidden tw-text-ellipsis"
                    [ngClass]="getCellValue(row, column.field)?.class || ['tw-bg-gray-100', 'tw-ring-gray-300']">
                    {{ getCellValue(row, column.field)?.label || 'Badge' }}
                  </span>

                  <!-- Number Content -->
                  <span *ngSwitchCase="'number'">
                    {{ getCellValue(row, column.field) | number: '1.0-2' }}
                  </span>

                  <!-- Select Dropdown -->
                  <div *ngSwitchCase="'select'" class="tw-relative">
                    <button
                      type="button"
                      cdkOverlayOrigin
                      #origin="cdkOverlayOrigin"
                      class="dropdown-button tw-border tw-border-gray-300 tw-rounded-md tw-px-3 tw-py-1 tw-w-full tw-text-sm tw-flex tw-items-center tw-justify-between tw-truncate tw-transition-all tw-duration-200 hover:tw-border-gray-400"
                      [id]="'dropdown-button-' + i + '-' + column.field"
                      (click)="toggleDropdown(i, column.field, origin, $event)"
                      [attr.aria-expanded]="isDropdownOpen(i, column.field)"
                      [ngClass]="[
                        isDisabledForm ? 'tw-bg-gray-100' : 'tw-bg-white',
                      ]">
                      <span class="tw-text-left tw-w-full tw-truncate"
                        [class.tw-text-gray-400]="!getCellValue(row, column.field)">
                        {{ getCellValue(row, column.field) || 'Select' }}
                      </span>
                      <app-icon name="chevron-down" [size]="16" fill="currentColor"
                        [extraClass]="'tw-ml-2 tw-flex-shrink-0 tw-transition-transform tw-duration-200 ' + (isDropdownOpen(i, column.field) ? 'tw-rotate-180' : '')">
                      </app-icon>
                    </button>
                  </div>

                  <!-- Button Content -->
                  <button *ngSwitchCase="'button'"
                    class="tw-text-white tw-px-3 tw-py-1 tw-rounded tw-font-medium tw-transition-all tw-duration-200 tw-min-w-[80px] disabled:tw-bg-gray-300 disabled:tw-cursor-not-allowed"
                    [disabled]="!row.POType" (click)="onButtonClick(column, row, $event)"
                    [ngClass]="{
                      'tw-bg-blue-500 hover:tw-bg-blue-600': column.buttonText === 'Submit',
                      'tw-bg-purple-700 hover:tw-bg-purple-800': column.buttonText === 'Register',
                      'tw-bg-gray-500 hover:tw-bg-gray-600': !column.buttonText || (column.buttonText !== 'Submit' && column.buttonText !== 'Register')
                    }">
                    {{ column.buttonText || 'Click' }}
                  </button>

                  <!-- Date Content -->
                  <span *ngSwitchCase="'date'">
                    {{ getCellValue(row, column.field) | date: 'dd/MM/yyyy':'UTC' }}
                  </span>
                  <span *ngSwitchCase="'dateWithTime'">
                    {{ getCellValue(row, column.field) | date: 'dd/MM/yyyy HH:mm':'UTC' }}
                  </span>

                  <!-- List Content -->
                  <div *ngSwitchCase="'list'">
                    <ol class="tw-list-decimal tw-pl-4 tw-space-y-1">
                      <li *ngFor="let item of getCellValue(row, column.field); let idx = index" class="tw-text-sm">
                        {{ item }}
                      </li>
                    </ol>
                  </div>

                  <!-- Icon Content -->
                  <div *ngSwitchCase="'icon'" class="tw-flex tw-justify-center tw-items-center">
                    <app-icon [name]="getCellValue(row, column.field)?.icon || 'default'"
                      [size]="getCellValue(row, column.field)?.size || 20"
                      [fill]="getCellValue(row, column.field)?.fill || 'currentColor'"
                      [extraClass]="getCellValue(row, column.field)?.extraClass || '' + 'tw-transition-colors tw-duration-200'">
                    </app-icon>
                  </div>

                  <!-- toggle Content -->
                  <div *ngSwitchCase="'toggle'">
                    <label class="tw-inline-flex tw-items-center tw-cursor-pointer" (click)="$event.stopPropagation()">
                      <input type="checkbox" value="" class="tw-sr-only tw-peer" [checked]="row.activeStatus && row.status!==32  && row.status!==0" (click)="onToggleChange($event, row)">
                      <div class="tw-relative tw-w-11 tw-h-6 peer-checked:tw-bg-[#00AA00] tw-bg-gray-200 tw-rounded-full tw-peer peer-checked:after:tw-translate-x-full rtl:peer-checked:after:tw--translate-x-full tw-border-white after:tw-content-[''] after:tw-absolute after:tw-top-[2px] after:tw-start-[2px] after:tw-bg-white after:tw-rounded-full after:tw-h-5 after:tw-w-5 after:tw-transition-all"
                        [ngClass]="{
                          'peer-checked:tw-bg-[#00AA00]/40': isDisabledForm
                        }"
                      ></div>
                    </label>
                  </div>

                  <!-- text link Content -->
                  <div *ngSwitchCase="'textlink'" class="tw-flex tw-justify-center tw-gap-4"
                    (click)="$event.stopPropagation()"
                  >
                    <a *ngIf="column.textlinkActions?.includes('view')" href="javascript:void(0)"
                      class="tw-text-[#5500FF] hover:tw-text-[#5f31bb] tw-flex tw-justify-center tw-gap-1 tw-items-center tw-font-semibold"
                      (click)="onClickView($event, row)">
                      <app-icon name="eye" [size]="20"></app-icon> <span>View</span>
                    </a>

                    <a *ngIf="column.textlinkActions?.includes('edit-topopup')" href="javascript:void(0)"
                      class="tw-text-[#D97706] hover:tw-text-[#a7671e] tw-flex tw-justify-center tw-gap-1 tw-items-center tw-font-semibold"
                      [class.tw-pointer-events-none]="isDisabledForm"
                      [class.tw-opacity-50]="isDisabledForm"
                      (click)="onClickEditDialog($event, row)">
                      <app-icon name="pen-to-square" [size]="20"></app-icon> <span>Edit</span>
                    </a>

                    <!-- <a *ngIf="column.textlinkActions?.includes('edit-card')" href="javascript:void(0)"
                      class="tw-text-[#D97706] hover:tw-text-[#a7671e] tw-flex tw-justify-center tw-gap-1 tw-items-center tw-font-semibold"
                      [class.tw-pointer-events-none]="isDisabledForm"
                      [class.tw-opacity-50]="isDisabledForm"
                      (click)="onClickEditCard($event, row)">
                      <app-icon name="pen-to-square" [size]="20"></app-icon> <span>Edit</span>
                    </a> -->

                    <a *ngIf="column.textlinkActions?.includes('edit-inrow') && editingRowId !== i+1 && !row._isNew"
                      class="tw-text-[#D97706] hover:tw-text-[#a7671e] tw-flex tw-justify-center tw-gap-1 tw-items-center tw-font-semibold"
                      [class.tw-pointer-events-none]="isDisabledForm"
                      [class.tw-opacity-50]="isDisabledForm"
                      (click)="onClickEdit($event, row, i+1)">
                      <app-icon name="pen-to-square" [size]="20"></app-icon> <span>Edit</span>
                    </a>

                    <!-- <ng-container *ngIf="row._isNew; else normalActions">
                      <a href="javascript:void(0)"
                        class="tw-text-[#00AA00] hover:tw-text-[#148014] tw-flex tw-items-center tw-gap-1 tw-font-semibold"
                        (click)="saveInlineCreate(row); $event.stopPropagation()">
                        <app-icon name="file-plus-circle" [size]="20"></app-icon> <span>Save</span>
                      </a>
                      <a href="javascript:void(0)"
                        class="tw-text-[#6C757D] hover:tw-text-[#404447] tw-flex tw-items-center tw-gap-1 tw-font-semibold"
                        (click)="cancelInlineCreate(row); $event.stopPropagation()">
                        <app-icon name="xmark" [size]="20"></app-icon> <span>Cancel</span>
                      </a>
                    </ng-container> -->

                    <!-- <ng-template #normalActions> -->
                      <ng-container *ngIf="editingRowId === i+1 && editRow">
                        <a href="javascript:void(0)"
                          class="tw-text-[#00AA00] hover:tw-text-[#148014] tw-flex tw-justify-center tw-gap-1 tw-items-center tw-font-semibold"
                          (click)="onClickSave($event, row)">
                          <app-icon name="file-plus-circle" [size]="20"></app-icon> <span>Save</span>
                        </a>

                        <a href="javascript:void(0)"
                          class="tw-text-[#6C757D] hover:tw-text-[#404447] tw-flex tw-justify-center tw-gap-1 tw-items-center tw-font-semibold"
                          (click)="onClickCancel($event, row)">
                          <app-icon name="xmark" [size]="20"></app-icon> <span>Cancel</span>
                        </a>
                      </ng-container>
                    <!-- </ng-template> -->

                    <a *ngIf="column.textlinkActions?.includes('delete') && editingRowId !== i+1 && !row._isNew" href="javascript:void(0)"
                      class="tw-text-[#F00] hover:tw-text-[#AA0000] tw-flex tw-justify-center tw-gap-1 tw-items-center tw-font-semibold"
                      [class.tw-pointer-events-none]="isDisabledForm"
                      [class.tw-opacity-50]="isDisabledForm"
                      (click)="onClickDelete($event, row)">
                      <app-icon name="trash" [size]="20"></app-icon> <span>Delete</span>
                    </a>
                  </div>

                </ng-container>
              </div>
            </td>
          </ng-container>
        </tr>
      </tbody>

      <tfoot *ngIf="isAddMode">
        <tr class="tw-sticky tw-bottom-0 tw-z-10 sticky-footer tw-border-t tw-border-gray-200">

          <ng-container *ngFor="let column of columns; trackBy: trackByColumn">
            <td class="tw-px-2 tw-py-2 tw-align-middle" [style.width]="getColumnWidth(column)">
              <ng-container [ngSwitch]="column.type || 'text'">
                <!-- __index -->
                <ng-container  *ngIf="column.field === '__index'" >
                  <div class="tw-text-center">
                    {{indexAdd}}
                  </div>
                </ng-container>

                <!-- textlink -->
                <ng-container *ngSwitchCase="'textlink'">
                  <div class="tw-flex tw-gap-3 tw-justify-center">
                    <a href="javascript:void(0)"
                      class="tw-text-[#00AA00] hover:tw-text-[#148014] tw-flex tw-items-center tw-gap-1 tw-font-semibold"
                      (click)="saveInlineCreate(footerRow)">
                      <app-icon name="file-plus-circle" [size]="20"></app-icon> <span>Save</span>
                    </a>
                    <a href="javascript:void(0)"
                      class="tw-text-[#6C757D] hover:tw-text-[rgb(64,68,71)] tw-flex tw-items-center tw-gap-1 tw-font-semibold"
                      (click)="cancelInlineCreate(footerRow)">
                      <app-icon name="xmark" [size]="20"></app-icon> <span>Cancel</span>
                    </a>
                  </div>
                </ng-container>

                <!-- toggle -->
                <ng-container *ngSwitchCase="'toggle'">
                  <label class="tw-flex tw-items-center tw-cursor-pointer tw-justify-center">
                    <input type="checkbox" class="tw-sr-only tw-peer"
                          [(ngModel)]="footerRow.activeStatus">
                    <div class="tw-relative tw-w-11 tw-h-6 peer-checked:tw-bg-[#00AA00] tw-bg-gray-200 tw-rounded-full tw-peer
                                peer-checked:after:tw-translate-x-full after:tw-content-[''] after:tw-absolute after:tw-top-[2px]
                                after:tw-start-[2px] after:tw-bg-white after:tw-rounded-full after:tw-h-5 after:tw-w-5 after:tw-transition-all">
                    </div>
                  </label>
                </ng-container>

                <!-- select -->
                <ng-container *ngSwitchCase="'select'">
                  <button
                    type="button"
                    cdkOverlayOrigin #footerOrigin="cdkOverlayOrigin"
                    class="dropdown-button tw-bg-white tw-border tw-border-gray-300 tw-rounded-md tw-px-3 tw-py-1 tw-w-full tw-text-sm tw-flex tw-items-center tw-justify-between tw-truncate tw-transition-all tw-duration-200 hover:tw-border-gray-400"
                    [id]="'dropdown-button-footer-' + column.field"
                    (click)="toggleFooterDropdown(column.field, footerOrigin, $event)"
                    [attr.aria-expanded]="isFooterDropdownOpen(column.field)">
                    <span class="tw-text-left tw-w-full tw-truncate" [class.tw-text-gray-400]="!footerRow[column.field]">
                      {{ footerRow[column.field] || 'Select' }}
                    </span>
                    <app-icon name="chevron-down" [size]="16"
                      fill="currentColor"
                      [extraClass]="'tw-ml-2 tw-flex-shrink-0 tw-transition-transform tw-duration-200 ' + (isFooterDropdownOpen(column.field) ? 'tw-rotate-180' : '')">
                    </app-icon> </button>
                </ng-container>

                <!-- date -->
                <ng-container *ngSwitchCase="'date'">
                  <input type="date"
                        class="tw-border tw-border-gray-300 tw-rounded tw-px-2 tw-py-1 tw-w-full tw-bg-white"
                        [(ngModel)]="footerRow[column.field]" />
                </ng-container>

                <!-- number -->
                <ng-container *ngSwitchCase="'number'">
                  <ng-container  *ngIf="column.field !== '__index'" >
                    <input type="number"
                      class="tw-border tw-border-gray-300 tw-rounded tw-px-2 tw-py-1 tw-w-full tw-bg-white"
                      [ngClass]="footerErrors[column.field] ? 'tw-border-red-500' : 'tw-border-gray-300'"
                      [(ngModel)]="footerRow[column.field]"
                      [attr.min]="(column.field === 'sort' || column.field === 'scoringMethod') ? 1 : null"
                      [attr.step]="(column.field === 'sort' || column.field === 'scoringMethod') ? 1 : null"
                      [attr.inputmode]="(column.field === 'sort' || column.field === 'scoringMethod') ? 'numeric' : null"
                      (keydown)="onFooterKeydown(column.field, $event)"
                      (input)="onFooterInput(column.field, $event)"
                      (blur)="onFooterBlur(column.field, $event)"
                    />
                  </ng-container>
                </ng-container>

                <!-- text -->
                <ng-container *ngSwitchDefault>
                  <ng-container *ngIf="column.type === 'text'; else emptyCell">
                    <input type="text"
                          class="tw-border tw-rounded tw-px-2 tw-py-1 tw-w-full tw-bg-white"
                          [ngClass]="fieldErrors || footerErrors[column.field] ? 'tw-border-red-500' : 'tw-border-gray-300'"
                          [(ngModel)]="footerRow[column.field]"
                          (input)="onFooterInput(column.field, $event)" />
                  </ng-container>
                  <ng-template #emptyCell>
                    <span></span>
                  </ng-template>
                </ng-container>

              </ng-container>
            </td>
          </ng-container>
        </tr>
      </tfoot>


      <!-- No Data Template -->
      <ng-template #noData>
        <tbody *ngIf="!isAddMode">
          <tr>
            <td [attr.colspan]="getVisibleColumnCount()" class="tw-text-center tw-py-8 tw-text-gray-500">
              <div class="tw-flex tw-flex-row tw-justify-center tw-items-center tw-gap-3">
                <app-icon name="xmark-circle" [size]="32" fill="currentColor" extraClass="tw-text-gray-300">
                </app-icon>
                <span class="tw-text-base tw-font-medium">No data available</span>
              </div>
            </td>
          </tr>
        </tbody>
      </ng-template>
    </table>
  </div>

  <!-- Single reusable overlay -->
  <ng-template #dropdownOverlayTpl let-ctx="ctx" let-width="width">
    <div
      class="tw-bg-white tw-shadow-xl tw-rounded-lg tw-max-h-[300px] tw-overflow-y-auto tw-min-w-[135px] tw-border tw-border-gray-200"
      [style.width.px]="width">
      <ul class="tw-py-1">
        <li *ngFor="let opt of ctx.options; trackBy: trackByOption"
          (click)="ctx.rowIndex === null ? selectFooterDropdownOption(ctx.field, opt) : selectDropdownOption(ctx.rowIndex, ctx.field, opt)"
          class="tw-px-4 tw-py-2 tw-text-sm tw-cursor-pointer tw-transition-colors tw-duration-150 hover:tw-bg-gray-100 tw-flex tw-items-center tw-justify-between"
          [class.tw-bg-[#E6F4FF]]="(ctx.rowIndex === null ? footerRow[ctx.field] : getCellValue(rowsValue[ctx.rowIndex], ctx.field)) === opt">
          <span>{{ opt }}</span> <app-icon
            *ngIf="(ctx.rowIndex === null ? footerRow[ctx.field] : getCellValue(rowsValue[ctx.rowIndex], ctx.field)) === opt"
            name="check" [size]="16" fill="currentColor" extraClass="tw-text-[#1677FF]"> </app-icon> </li>
      </ul>
    </div>
  </ng-template>
</div>
