<div class="tw-flex tw-gap-4 tw-overflow-x-auto tw-scrollbar-hide tw-py-4 tw-mx-6" [ngClass]="directCol ? 'tw-flex-col' : ''">
  @for (group of items; track group.groupKey) {
  <div class="tw-group tw-flex-1 tw-min-w-[200px]">
    <!-- Card Container -->
    <div class="tw-bg-white tw-rounded-lg tw-shadow-sm tw-border tw-border-gray-200 
                  tw-transition-all tw-duration-300 tw-ease-out
                  hover:tw-shadow-md hover:tw--translate-y-0.5b"
          [ngClass]="expandedGroups.has(group.groupKey) ? 'tw-h-full' : 'tw-h-auto'">

      <!-- Header -->
      <div class="tw-relative tw-overflow-hidden tw-rounded-t-lg tw-bg-white tw-rounded-lg">
        <div class="tw-flex tw-justify-between tw-items-center tw-p-4 tw-cursor-pointer
                      tw-transition-all tw-duration-200 hover:tw-bg-gray-50" (click)="toggleGroup(group.groupKey)">

          <div class="tw-flex tw-items-center tw-gap-3">
            <h3 class="tw-font-bold tw-text-dark-900 tw-text-base tw-leading-tight">
              {{ group.groupLabel }}
            </h3>
              <!-- Badge for selected count -->
              @if (getCheckedCount(group.groupKey) > 0) {
                <span class="tw-inline-flex tw-items-center tw-px-2.5 tw-py-1 tw-rounded-full 
                           tw-text-xs tw-font-semibold bg-azure tw-text-white
                           tw-animate-pulse">
                  {{ getCheckedCount(group.groupKey) }}
                </span>
              }
          </div>

          <!-- Toggle Icon -->
          <div class="tw-flex tw-items-center tw-justify-center tw-w-5 tw-h-5 
                        tw-transition-transform tw-duration-300 tw-ease-out
                        tw-text-gray-500" [class.tw-rotate-180]="isExpanded(group.groupKey)">
            <app-icon name="chevron-down" [size]="16" fill="currentColor">
            </app-icon>
          </div>
        </div>
      </div>

      <!-- Content Area -->
      <div class="tw-transition-all tw-animate-in tw-slide-in-from-top-2 tw-fade-in tw-duration-300"
        [ngClass]="canScroll ? 'tw-overflow-auto tw-max-h-[350px]' : 'tw-overflow-hidden'"
        [class.tw-max-h-0]="!isExpanded(group.groupKey)" [class.tw-max-h-96]="isExpanded(group.groupKey)">
        @if (isExpanded(group.groupKey)) {
        <div class="tw-space-y-1">
          @for (option of group.options; track option.key; let i = $index) {
          <label class="tw-group/option tw-flex tw-items-center tw-gap-3 tw-cursor-pointer 
                           tw-px-4 tw-py-2 tw-transition-all tw-duration-200 tw-ease-out
                           hover:tw-bg-gray-50 tw-border-t tw-border-[#E5E5E5] last:tw-rounded-b-md !tw-mt-[0px]" 
                 [style.animation-delay]="i * 30 + 'ms'">

            <!-- Custom Checkbox -->
            <div class="tw-relative tw-flex tw-items-center">
              <input type="checkbox" class="tw-sr-only tw-peer" 
                     [checked]="isChecked(group.groupKey, option.key)"
                     (change)="toggleOption(group.groupKey, option.key)" />

              <!-- Checkbox Visual with Dynamic Color -->
              <div class="tw-w-4 tw-h-4 tw-border tw-border-gray-300 tw-rounded 
                               tw-transition-all tw-duration-200 tw-ease-out tw-overflow-hidden tw-relative">

                <div class="tw-w-full tw-h-full tw-absolute tw-rounded-[2px]
                            tw-flex tw-items-end tw-justify-center tw-text-white
                            tw-transition-all tw-duration-200 tw-ease-out"
                     [style.background-color]="option.color || '#1E90FF'"
                     [class.tw-opacity-100]="isChecked(group.groupKey, option.key)"
                     [class.tw-scale-100]="isChecked(group.groupKey, option.key)"
                     [class.tw-opacity-0]="!isChecked(group.groupKey, option.key)"
                     [class.tw-scale-0]="!isChecked(group.groupKey, option.key)">
                  <app-icon name="check" [size]="14" fill="#fff"></app-icon>
                </div>
              </div>
            </div>

            <!-- Label with Color Indicator -->
            <div class="tw-flex tw-items-center tw-gap-2 tw-flex-1">
              <!-- Color Dot Indicator -->
              @if (option.color) {
                <div class="tw-w-2 tw-h-2 tw-rounded-full tw-transition-all tw-duration-200"
                     [style.background-color]="option.color"
                     [class.tw-scale-125]="isChecked(group.groupKey, option.key)"
                     [class.tw-opacity-100]="isChecked(group.groupKey, option.key)"
                     [class.tw-opacity-60]="!isChecked(group.groupKey, option.key)">
                </div>
              }
              
              <span class="tw-text-sm tw-font-normal tw-leading-relaxed 
                           tw-transition-colors tw-duration-200" 
                    [class.tw-font-medium]="isChecked(group.groupKey, option.key)"
                    [class.tw-text-gray-700]="!isChecked(group.groupKey, option.key)"
                    [class.group-hover\:tw-text-gray-900]="!isChecked(group.groupKey, option.key)"
                    [style.color]="isChecked(group.groupKey, option.key) && option.color ? option.color : null">
                {{ option.label }}
              </span>
            </div>

          </label>
          } @empty {
          <div class="tw-flex tw-flex-col tw-items-center tw-justify-center tw-py-6 tw-text-center">
            <div class="tw-w-8 tw-h-8 tw-bg-gray-100 tw-rounded-full tw-flex tw-items-center tw-justify-center tw-mb-2">
              <svg class="tw-w-4 tw-h-4 tw-text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2 2v-5m16 0h-2M4 13h2" />
              </svg>
            </div>
            <p class="tw-text-gray-500 tw-text-xs tw-font-medium">ไม่มีตัวเลือก</p>
          </div>
          }
        </div>
        }
      </div>
    </div>
  </div>
  } @empty {
  <div class="tw-flex tw-flex-col tw-items-center tw-justify-center tw-w-full tw-py-16 tw-text-center">
    <div class="tw-w-20 tw-h-20 tw-bg-gray-100 tw-rounded-full tw-flex tw-items-center tw-justify-center tw-mb-4">
      <svg class="tw-w-10 tw-h-10 tw-text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
      </svg>
    </div>
    <h3 class="tw-text-gray-600 tw-text-lg tw-font-semibold tw-mb-2">ไม่มีตัวกรอง</h3>
    <p class="tw-text-gray-500 tw-text-sm">ยังไม่มีตัวเลือกการกรองที่พร้อมใช้งาน</p>
  </div>
  }
</div>