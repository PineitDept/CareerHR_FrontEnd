<div class="tw-flex tw-flex-wrap tw-items-center tw-gap-4 tw-px-6 tw-py-6 tw-bg-white"
  [ngClass]="!filterDate ? ' tw-justify-end' : 'tw-justify-between'">

  <!-- Left Section -->
  <div class="tw-flex tw-gap-4" [ngClass]="filterDate ? 'tw-block' : 'tw-hidden'">

    <!-- Back Button -->
    <button *ngIf="filterDynamicButton && !GradeSelect && !ButtonBackSave" (click)="onBackClick()"
      class="tw-flex tw-items-center tw-gap-2 tw-bg-transparent tw-text-[#212529] tw-rounded-lg tw-px-2 tw-py-1 tw-text-base tw-font-semibold mb-hide">
      <app-icon name="chevron-left" [size]="16" />
      <span>Back</span>
    </button>

    <button *ngIf="ButtonBackSave && filterDynamicButton" (click)="onBackSave()"
      class="tw-flex tw-items-center tw-gap-2 tw-bg-transparent tw-text-[#212529] tw-rounded-lg tw-px-2 tw-py-1 tw-text-base tw-font-semibold"
      >
      <app-icon name="chevron-left" [size]="16" />
      <span>Back</span>
    </button>

    <!-- Year Dropdown -->
    <div class="tw-relative dropdown tw-min-w-[135px]" #yearDropdown
      *ngIf="!filterDynamicButton && !disabledFilterDateRange && !GradeSelect">
      <button (click)="toggleDropdown('year')"
        class="tw-w-full tw-bg-black tw-text-white tw-rounded-lg tw-px-4 tw-py-2 tw-text-base tw-flex tw-items-center tw-justify-between tw-gap-2">
        {{ selectedYear }}
        <app-icon name="chevron-down" [size]="16" />
      </button>

      <ul *ngIf="isYearOpen"
        class="tw-absolute tw-bg-white tw-shadow-md tw-rounded-lg tw-mt-1 tw-z-20 tw-w-full tw-min-w-[100px] tw-p-1"
      >
        <!-- รายการปีปกติ (ยกเว้น Other) -->
        <li *ngFor="let y of years.slice(0, years.length - 1)"
            (click)="selectOption('year', y)"
            class="tw-px-4 tw-py-2 tw-text-base tw-cursor-pointer hover:tw-bg-gray-100"
            [ngClass]="{ 'tw-bg-gray-200': isYearActive(y) }"
            [attr.aria-selected]="isYearActive(y)">
          <div class="tw-flex tw-items-center tw-justify-between">
            <span>{{ y }}</span>
            <app-icon *ngIf="isYearActive(y)" name="check" [size]="16"></app-icon>
          </div>
        </li>

        <!-- แถว Other -->
        <li class="tw-rounded hover:tw-bg-gray-100"
            [ngClass]="{ 'tw-bg-gray-200': isOtherActive() }"
            [attr.aria-selected]="isOtherActive()">
          <!-- หัวข้อ Other -->
          <div
            class="tw-flex tw-items-center tw-justify-between tw-cursor-pointer tw-px-4 tw-py-2"
            (click)="onOtherHeaderClick()"
            role="button"
            aria-label="Other year"
          >
            <span class="tw-text-base">Other</span>

            <!-- ไม่ขยาย = chevron-left + หมุน 180°, ขยายแล้ว = chevron-down -->
            <app-icon
              [name]="otherYearMode ? 'chevron-down' : 'chevron-left'"
              [size]="16"
              [ngClass]="!otherYearMode ? 'tw-transform tw-rotate-180 tw-transition-transform tw-duration-150' : ''"
            ></app-icon>
          </div>

          <!-- กล่องกรอกเลข + ปุ่มยืนยัน -->
          <div *ngIf="otherYearMode" class="tw-mt-2 tw-px-4 tw-pb-2" (click)="onOtherContainerClick($event)">
            <div class="tw-flex tw-items-center tw-gap-2">
              <input
                #otherYearInputRef
                type="number"
                inputmode="numeric"
                min="1900"
                [max]="currentYear + 50"
                class="tw-w-[110px] tw-border tw-border-gray-300 tw-rounded tw-px-2 tw-py-1 tw-text-base focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-black"
                [(ngModel)]="otherYearInput"
              />
            </div>

            <button
              type="button"
              class="tw-mt-2 tw-w-full tw-bg-black tw-text-white tw-rounded tw-px-3 tw-py-2 tw-text-sm"
              (click)="onConfirmOtherYear($event)"
            >
              Confirm
            </button>
          </div>
        </li>
      </ul>
    </div>

    <!-- Month Dropdown -->
    <div class="tw-relative dropdow tw-min-w-[135px]" #monthDropdown
      *ngIf="!filterDynamicButton && !disabledFilterDateRange && !GradeSelect">
      <button (click)="toggleDropdown('month')"
        class="tw-w-full tw-bg-black tw-text-white tw-rounded-lg tw-px-4 tw-py-2 tw-text-base tw-flex tw-items-center tw-justify-between tw-gap-2">
        {{ selectedMonth }}
        <app-icon name="chevron-down" [size]="16" />
      </button>
      <ul *ngIf="isMonthOpen"
        class="tw-absolute tw-bg-white tw-shadow-md tw-rounded-lg tw-mt-1 tw-z-20 tw-w-full tw-min-w-[100px]">
        <li *ngFor="let m of months"
            (click)="selectOption('month', m)"
            class="tw-px-4 tw-py-2 tw-text-base tw-cursor-pointer hover:tw-bg-gray-100"
            [ngClass]="{ 'tw-bg-gray-200': isMonthActive(m) }"
            [attr.aria-selected]="isMonthActive(m)">
          <div class="tw-flex tw-items-center tw-justify-between">
            <span>{{ m }}</span>
            <app-icon *ngIf="isMonthActive(m)" name="check" [size]="16"></app-icon>
          </div>
        </li>
      </ul>
    </div>

    <!-- Grade Dropdown -->
    <div class="tw-relative dropdow tw-min-w-[135px]" #gradeDropdown *ngIf="!filterDynamicButton && GradeSelect">
      <button (click)="toggleDropdown('grade')"
        class="tw-w-full tw-bg-black tw-text-white tw-rounded-lg tw-px-4 tw-py-2 tw-text-base tw-flex tw-items-center tw-justify-between tw-gap-2">
        {{ selectedGrade }}
        <app-icon name="chevron-down" [size]="16" />
      </button>
      <ul *ngIf="isGradeOpen"
        class="tw-absolute tw-bg-white tw-shadow-md tw-rounded-lg tw-mt-1 tw-z-20 tw-w-full tw-min-w-[100px]">
        <li *ngFor="let g of allGrade" (click)="selectOption('grade', g)"
          class="tw-px-4 tw-py-2 tw-text-base tw-cursor-pointer hover:tw-bg-gray-100">
          {{ g }}
        </li>
      </ul>
    </div>

    <!-- All List Button -->
    <button class="tw-bg-[#660708] tw-text-white tw-rounded-lg tw-px-4 tw-py-2 tw-text-base tw-min-w-[112px]"
      (click)="onAllListClick()"
      *ngIf="!filterDynamicButton && !disabledFilterDateRange && !GradeSelect && !DateCalendar">
      All List
    </button>

    <!-- All List Button -->
    <button class="tw-bg-[#660708] tw-text-white tw-rounded-lg tw-px-4 tw-py-2 tw-text-base tw-min-w-[112px]"
      (click)="onClickToday()" *ngIf="DateCalendar">
      Today
    </button>
  </div>

  <!-- Right Section -->
  <div class="tw-flex tw-gap-4">

    <!-- Company Toggle Buttons -->
    <div class="tw-flex" *ngIf="!filterDynamicButton && filterOurCompany">
      <ng-container *ngFor="let company of ourCompany">
        <button [ngClass]="{
            'tw-bg-[#660708] !tw-text-white': selectedCompany === company,
            'tw-bg-[#930000] tw-text-white': selectedCompany !== company
          }" class="tw-px-4 tw-py-2 tw-text-base" (click)="selectOption('company', company)">
          {{ company }}
        </button>
      </ng-container>
    </div>

    <!-- Dynamic Buttons -->
    <ng-container *ngFor="let btn of actionButtons">
      <!-- ปุ่มแบบ Select (มี options) -->
      <div class="tw-relative tw-min-w-[120px]" *ngIf="btn.options?.length; else normalBtn">
        <button (click)="toggleActionDropdown(btn.key, $event)"
          class="btn-dynamic tw-rounded-lg tw-px-4 tw-py-2 tw-text-base tw-w-full tw-inline-flex tw-items-center tw-justify-between"
          [style.--btn-bg]="btn.color || '#0A84FF'" [style.--btn-ring]="btn.borderColor || btn.color || '#0A84FF'"
          [style.color]="btn.textColor || (isWhite(btn.color) ? '#111827' : '#FFFFFF')"
          [class.tw-border]="isWhite(btn.color) || btn.outlineBtn || !!btn.borderColor"
          [style.borderColor]="btn.borderColor || (isWhite(btn.color) ? '#D1D5DB' : 'transparent')" [ngClass]="btn.outlineBtn
            ? '!tw-bg-transparent tw-border tw-border-black !tw-text-black tw-font-bold hover:!tw-bg-black hover:!tw-text-white'
            : ''">
          <span>{{ btn.label }}</span>
          <app-icon name="chevron-down" [size]="16"></app-icon>
        </button>

        <ul *ngIf="openActionKey === btn.key"
          class="tw-absolute tw-right-0 tw-bg-white tw-shadow-md tw-rounded-lg tw-mt-1 tw-z-20 tw-w-full tw-min-w-[140px]">
          <li *ngFor="let opt of btn.options" (click)="selectActionOption(btn, opt, $event)"
            class="tw-px-4 tw-py-2 tw-text-base tw-cursor-pointer hover:tw-bg-gray-100">
            {{ opt.label }}
          </li>
        </ul>
      </div>

      <!-- ปุ่มแบบปกติ -->
      <ng-template #normalBtn>
        <button class="btn-dynamic tw-rounded-lg tw-px-4 tw-py-2 tw-text-base
                disabled:tw-opacity-50 disabled:tw-cursor-not-allowed tw-min-w-[120px]"
          [style.--btn-bg]="btn.color || '#0A84FF'" [style.--btn-ring]="btn.borderColor || btn.color || '#0A84FF'"
          [style.color]="btn.textColor || (isWhite(btn.color) ? '#111827' : '#FFFFFF')"
          [class.tw-border]="isWhite(btn.color) || btn.outlineBtn || !!btn.borderColor"
          [style.borderColor]="btn.borderColor || (isWhite(btn.color) ? '#D1D5DB' : 'transparent')"
          (click)="onActionButtonClick(btn.key)"
          [disabled]="disabledKeys.includes(btn.key) || ((btn.key === 'submit' || btn.key === 'register') && (!(selectedRows.length)))">
          {{ btn.label }}
        </button>
      </ng-template>

    </ng-container>
  </div>
</div>
