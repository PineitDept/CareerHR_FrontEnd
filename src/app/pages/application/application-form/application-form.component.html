<!-- sentinel สำหรับ back-to-top -->
<div
  id="page-top-sentinel"
  class="tw-h-px tw-w-px tw-opacity-0"
  aria-hidden="true"
></div>
<div class="tw-sticky tw-top-0 tw-z-[30] tw-bg-white">
  <app-header-content
    [headerName]="'Job Application Form'"
    [headerType]="''"
  ></app-header-content>
</div>
<app-filter
  [actionButtons]="filterButtons"
  [disabledKeys]="disabledKeys"
  [filterDynamicButton]="true"
  (buttonClicked)="onFilterButtonClick($event)"
  (selectChanged)="onFilterSelectChanged($event)"
></app-filter>

<app-loading></app-loading>

<!-- ================= MAIN GRID ================= -->
<div class="tw-grid tw-grid-cols-4 tw-gap-6 tw-px-6 tw-py-6 tw-bg-white">
  <!-- =============== LEFT (3 cols) =============== -->
  <div class="tw-col-span-3 tw-space-y-6">
    <!-- ===== Applicant Header Card ===== -->
    <section
      class="tw-bg-white tw-rounded-xl tw-shadow-[0_6px_12px_rgba(0,0,0,0.3)] tw-flex tw-items-stretch overflow-hidden"
    >
      <!-- Avatar -->
      <div
        class="tw-w-[20%] tw-shrink-0 tw-overflow-hidden tw-rounded-l-xl tw-flex tw-items-center tw-justify-center tw-bg-gray-100"
      >
        <ng-container *ngIf="applicant.avatarUrl; else noAvatar">
          <img
            class="tw-w-full tw-h-full tw-object-cover"
            [src]="applicant.avatarUrl"
            alt="avatar"
          />
        </ng-container>
        <ng-template #noAvatar>
          <app-icon name="user" [size]="81" class="tw-text-gray-400"></app-icon>
        </ng-template>
      </div>

      <!-- Info -->
      <div class="tw-flex-1 tw-space-y-2 tw-px-6 tw-py-4">
        <div class="tw-flex tw-items-center tw-justify-between">
          <div>
            <div
              class="tw-inline-flex tw-items-center tw-gap-2 tw-text-[14px] tw-font-semibold tw-bg-[#DDF7F8] tw-text-[#29C6CF] tw-px-2 tw-py-1 tw-rounded-md"
            >
              Applied Date {{ applicant.appliedDate | date : "dd MMM yyyy" }}
            </div>
          </div>
        </div>

        <div class="tw-text-[22px] tw-font-semibold">{{ applicant.name }}</div>

        <div class="tw-text-[14px] tw-font-medium">
          {{ applicant.university }} {{ applicant.faculty }}
          {{ applicant.program }}
        </div>

        <div class="tw-text-[14px] !tw-mt-0">
          <ng-container *ngIf="applicant.gpa as gpa">
            <span class="tw-font-medium">GPA </span>
            <span class="tw-font-medium">{{ gpa }}</span>
          </ng-container>
        </div>

        <div class="tw-space-y-2 tw-py-2 !tw-mb-2">
          <div class="tw-text-[14px]">
            <div class="tw-text-gray-500 tw-font-medium">Applied Position</div>
            <div class="tw-whitespace-pre-line">
              <ng-container
                *ngFor="let pos of applicant.positions; let i = index"
              >
                {{ pos
                }}<ng-container
                  *ngIf="i < (applicant.positions.length || 0) - 1"
                  ><br
                /></ng-container>
              </ng-container>
            </div>
          </div>

          <div class="tw-pt-2">
            <div class="tw-text-[14px] tw-flex">
              <div class="tw-text-gray-500 tw-font-medium">Email :</div>
              <div class="tw-ml-1">{{ applicant.email }}</div>
            </div>
            <div class="tw-text-[14px] tw-flex">
              <div class="tw-text-gray-500 tw-font-medium">Phone :</div>
              <div class="tw-ml-1">{{ applicant.phone }}</div>
            </div>
          </div>
        </div>

        <hr class="tw--mx-0 !tw-mt-4" />

        <div
          class="tw-flex tw-items-center tw-justify-between tw-pt-3 tw-text-[14px] tw-text-gray-500"
        >
          <div class="tw-text-gray-500 tw-font-medium">
            Applicant Grade {{ applicant.grade }}
          </div>

          <!-- Like / Unlike -->
          <button
            type="button"
            class="tw-inline-flex tw-items-center tw-gap-2 tw-rounded-md tw-px-2 tw-py-1 hover:tw-bg-gray-100 disabled:tw-opacity-60 disabled:tw-cursor-not-allowed"
            [disabled]="likeState.loading || !applicantId"
            (click)="onToggleLike()"
            [attr.aria-pressed]="likeState.liked"
            [title]="likeState.liked ? 'Unlike' : 'Like'"
          >
            <app-icon
              [name]="likeState.liked ? 'thumbs-up-solid' : 'thumbs-up'"
              [size]="18"
              [ngClass]="likeState.liked ? 'tw-text-[#0A57C3]' : 'tw-text-inherit'"
            ></app-icon>
            <span>{{ likeState.count }}</span>
          </button>
        </div>
      </div>
    </section>

    <!-- ===== Process Tabs / Pipeline ===== -->
    <section class="tw-w-full">
      <div class="tw-overflow-x-auto tw-scroll-px-6">
        <div class="tw-min-w-full">
          <div class="tw-w-fit tw-min-w-full tw-mx-auto">
            <app-stepper
              [items]="stepperItems"
              [activeIndex]="activeStepIndex"
              [disableStep]="disabledStepLabels"
              [theme]="'soft'"
              (stepChanged)="onStepperChanged($event)"
            ></app-stepper>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== Application Assessment ===== -->
    <section class="tw-w-full" id="section-applied">
      <form [formGroup]="formDetails">
        <div class="tw-bg-[#FFFFFF]">
          <div
            class="tw-bg-white tw-px-6 tw-pt-4 tw-rounded-xl tw-shadow-[0_6px_12px_rgba(0,0,0,0.3)]"
          >
            <!-- Header + Chevron (expand/collapse) -->
            <div
              class="tw-flex tw-items-center tw-justify-between tw-cursor-pointer"
              (click)="isRevOpen = !isRevOpen"
            >
              <label class="tw-text-lg tw-font-bold">Application Assessment</label>
              <app-icon
                name="chevron-down"
                [size]="14"
                [extraClass]="
                  isRevOpen
                    ? 'tw-rotate-180 tw-transition-transform'
                    : 'tw-transition-transform'
                "
              ></app-icon>
            </div>

            <hr class="tw--mx-6 tw-mt-4" />

            <!-- เนื้อหาโชว์เมื่อเปิด -->
            <ng-container *ngIf="isRevOpen">
              <div class="tw--mx-6 tw-rounded-b-xl tw-overflow-hidden">
                <app-tables
                  [rows]="assessmentRows"
                  [columns]="assessmentColumns"
                  [showCheckbox]="false"
                  [splitRows]="false"
                  [hasOverflowY]="false"
                  [enableRowClick]="false"
                  [withinCard]="true"
                  [isDisabledForm]="true"
                ></app-tables>
              </div>
            </ng-container>
          </div>
        </div>
      </form>
    </section>
    <!-- /Application Assessment -->

    <!-- ===== Candidate Warning ===== -->
    <section class="tw-w-full">
      <form [formGroup]="formDetails">
        <div class="tw-bg-[#FFFFFF]">
          <div class="tw-bg-white tw-px-6 tw-pt-4 tw-rounded-xl tw-shadow-[0_6px_12px_rgba(0,0,0,0.3)]">
            <!-- Header + Chevron (expand/collapse) -->
            <div
              class="tw-flex tw-items-center tw-justify-between tw-cursor-pointer"
              (click)="isWarnOpen = !isWarnOpen"
            >
              <label class="tw-text-lg tw-font-bold">Candidate Warning</label>
              <app-icon
                name="chevron-down"
                [size]="14"
                [extraClass]="
                  isWarnOpen
                    ? 'tw-rotate-180 tw-transition-transform'
                    : 'tw-transition-transform'
                "
              ></app-icon>
            </div>

            <hr class="tw--mx-6 tw-mt-4" />

            <!-- เนื้อหาโชว์เมื่อเปิด -->
            <ng-container *ngIf="isWarnOpen">
              <div class="tw--mx-6 tw-rounded-b-xl tw-overflow-hidden">
                <app-tables
                  [rows]="warningRows"
                  [columns]="warningColumns"
                  [showCheckbox]="false"
                  [splitRows]="false"
                  [hasOverflowY]="false"
                  [enableRowClick]="false"
                  [withinCard]="true"
                  [isDisabledForm]="true"
                ></app-tables>
              </div>
            </ng-container>
          </div>
        </div>
      </form>
    </section>
    <!-- /Candidate Warning -->

    <!-- ===== Stage History (dynamic with non-summary insertion) ===== -->
    <section
      class="tw-w-full"
      *ngFor="let s of stageSections; let k = index"
      [attr.id]="'section-' + slugify(s.stageNameNormalized) + '-' + k"
      [attr.data-stage]="s.stageNameNormalized"
    >

      <!-- ===== Insert Interview 1 non-summary BEFORE its summary card ===== -->
      <ng-container *ngIf="shouldInsertNonSummary('i1', s, k) && (interview1NonSummary?.length)">
        <section class="tw-relative group" [ngClass]="{ 'tw-mb-6': hasStageSummary('i1') }">
          <ngx-slick-carousel
            #i1Carousel
            class="tw-grid grid-cols-auto tw-gap-8"
            [config]="slideConfigI1"
            (init)="onCarouselInit($event, 0)"
            (afterChange)="onSlideChanged($event, 0)"
          >
            <div ngxSlickItem *ngFor="let review of interview1NonSummary; let i = index">
              <div
                class="tw-col-span-2 tw-row-span-2 tw-space-y-4 tw-bg-white tw-px-6 tw-pt-4 tw-pb-6 tw-rounded-xl tw-shadow-[0_6px_12px_rgba(0,0,0,0.3)]"
                style="height:-webkit-fill-available;"
              >
                <div class="header-slide">
                  <div class="tw-flex tw-items-center tw-justify-between tw-mb-3">
                    <div>
                      <span class="tw-text-[20px] tw-mr-3 tw-font-bold">{{ review.hrUserName }}</span>
                    </div>
                    <div
                      class="tw-p-1 tw-px-2 tw-border tw-rounded-lg tw-font-bold"
                      [ngClass]="badgeClassForCategory(review.categoryName)"
                    >
                      {{ review.categoryName }}
                    </div>
                  </div>
                  <hr class="tw--mx-6 !tw-mt-4" />
                </div>

                <div class="body-slide">
                  <!-- Reason -->
                  <div class="tw-mb-4">
                    <div class="tw-mb-1.5"><label class="tw-text-sm tw-font-semibold">Reason</label></div>
                    <div class="list-top">
                      <div class="tw-flex tw-flex-col tw-w-full tw-gap-4 !tw-mt-0">
                        <label *ngFor="let reason of (review.selectedReasonTexts || [])"
                          class="tw-flex tw-items-start tw-pointer-events-none">
                          <span
                            role="checkbox"
                            aria-checked="true"
                            class="tw-inline-flex tw-items-center tw-justify-center tw-rounded-[4px] tw-border tw-align-middle tw-mt-0.5 tw-border-[#D97706] tw-bg-[#FFF7ED]"
                            style="width:18px;height:18px;min-width:18px;min-height:18px">
                            <app-icon name="check" [size]="14" class="tw-text-[#D97706]"></app-icon>
                          </span>
                          <span class="tw-ml-2 tw-text-sm">{{ reason }}</span>
                        </label>
                      </div>
                    </div>
                  </div>

                  <!-- Strength -->
                  <div class="tw-mb-4">
                    <div class="tw-mb-1.5"><label class="tw-text-sm tw-font-semibold">Strength</label></div>
                    <div class="review-card">
                      <span #i1StrengthText
                            [ngClass]="{ 'ellipsis-3-lines': !review.expandState?.strength }"
                            class="tw-text-sm tw-text-gray-800">
                        {{ review.strength || '-' }}
                      </span>
                      <a *ngIf="review.overflowState?.strength"
                        (click)="toggleExpandNonSummary('i1', i, 'strength')"
                        class="tw-text-black tw-font-bold tw-text-sm tw-mt-1 tw-underline tw-bg-transparent tw-border-0 tw-p-0 tw-cursor-pointer">
                        {{ review.expandState?.strength ? 'ย่อลง' : 'อ่านต่อ' }}
                      </a>
                    </div>
                  </div>

                  <!-- Concern -->
                  <div>
                    <div class="tw-mb-1.5"><label class="tw-text-sm tw-font-semibold">Concern</label></div>
                    <div class="review-card">
                      <span #i1ConcernText
                            [ngClass]="{ 'ellipsis-3-lines': !review.expandState?.concern }"
                            class="tw-text-sm tw-text-gray-800">
                        {{ review.concern || '-' }}
                      </span>
                      <a *ngIf="review.overflowState?.concern"
                        (click)="toggleExpandNonSummary('i1', i, 'concern')"
                        class="tw-text-black tw-font-bold tw-text-sm tw-mt-1 tw-underline tw-bg-transparent tw-border-0 tw-p-0 tw-cursor-pointer">
                        {{ review.expandState?.concern ? 'ย่อลง' : 'อ่านต่อ' }}
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </ngx-slick-carousel>
        </section>
      </ng-container>

      <!-- ===== Insert Interview 2 non-summary BEFORE its summary card ===== -->
      <ng-container *ngIf="shouldInsertNonSummary('i2', s, k) && (interview2NonSummary?.length)">
        <section class="tw-relative group" [ngClass]="{ 'tw-mb-6': hasStageSummary('i2') }">
          <ngx-slick-carousel
            #i2Carousel
            class="tw-grid grid-cols-auto tw-gap-8"
            [config]="slideConfigI2"
            (init)="onCarouselInit($event, 1)"
            (afterChange)="onSlideChanged($event, 1)"
          >
            <div ngxSlickItem *ngFor="let review of interview2NonSummary; let i = index">
              <div
                class="tw-col-span-2 tw-row-span-2 tw-space-y-4 tw-bg-white tw-px-6 tw-pt-4 tw-pb-6 tw-rounded-xl tw-shadow-[0_6px_12px_rgba(0,0,0,0.3)]"
                style="height:-webkit-fill-available;"
              >
                <div class="header-slide">
                  <div class="tw-flex tw-items-center tw-justify-between tw-mb-3">
                    <div>
                      <span class="tw-text-[20px] tw-mr-3 tw-font-bold">{{ review.hrUserName }}</span>
                    </div>
                    <div
                      class="tw-p-1 tw-px-2 tw-border tw-rounded-lg tw-font-bold"
                      [ngClass]="badgeClassForCategory(review.categoryName)"
                    >
                      {{ review.categoryName }}
                    </div>
                  </div>
                  <hr class="tw--mx-6 !tw-mt-4" />
                </div>

                <div class="body-slide">
                  <!-- Reason -->
                  <div class="tw-mb-4">
                    <div class="tw-mb-1.5"><label class="tw-text-sm tw-font-semibold">Reason</label></div>
                    <div class="list-top">
                      <div class="tw-flex tw-flex-col tw-w-full tw-gap-4 !tw-mt-0">
                        <label *ngFor="let reason of (review.selectedReasonTexts || [])"
                          class="tw-flex tw-items-start tw-pointer-events-none">
                          <span
                            role="checkbox"
                            aria-checked="true"
                            class="tw-inline-flex tw-items-center tw-justify-center tw-rounded-[4px] tw-border tw-align-middle tw-mt-0.5 tw-border-[#D97706] tw-bg-[#FFF7ED]"
                            style="width:18px;height:18px;min-width:18px;min-height:18px">
                            <app-icon name="check" [size]="14" class="tw-text-[#D97706]"></app-icon>
                          </span>
                          <span class="tw-ml-2 tw-text-sm">{{ reason }}</span>
                        </label>
                      </div>
                    </div>
                  </div>

                  <!-- Strength -->
                  <div class="tw-mb-4">
                    <div class="tw-mb-1.5"><label class="tw-text-sm tw-font-semibold">Strength</label></div>
                    <div class="review-card">
                      <span #i2StrengthText
                            [ngClass]="{ 'ellipsis-3-lines': !review.expandState?.strength }"
                            class="tw-text-sm tw-text-gray-800">
                        {{ review.strength || '-' }}
                      </span>
                      <a *ngIf="review.overflowState?.strength"
                        (click)="toggleExpandNonSummary('i2', i, 'strength')"
                        class="tw-text-black tw-font-bold tw-text-sm tw-mt-1 tw-underline tw-bg-transparent tw-border-0 tw-p-0 tw-cursor-pointer">
                        {{ review.expandState?.strength ? 'ย่อลง' : 'อ่านต่อ' }}
                      </a>
                    </div>
                  </div>

                  <!-- Concern -->
                  <div>
                    <div class="tw-mb-1.5"><label class="tw-text-sm tw-font-semibold">Concern</label></div>
                    <div class="review-card">
                      <span #i2ConcernText
                            [ngClass]="{ 'ellipsis-3-lines': !review.expandState?.concern }"
                            class="tw-text-sm tw-text-gray-800">
                        {{ review.concern || '-' }}
                      </span>
                      <a *ngIf="review.overflowState?.concern"
                        (click)="toggleExpandNonSummary('i2', i, 'concern')"
                        class="tw-text-black tw-font-bold tw-text-sm tw-mt-1 tw-underline tw-bg-transparent tw-border-0 tw-p-0 tw-cursor-pointer">
                        {{ review.expandState?.concern ? 'ย่อลง' : 'อ่านต่อ' }}
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </ngx-slick-carousel>
        </section>
      </ng-container>

      <!-- ===== Stage History card (summary only) ===== -->
      <form [formGroup]="formDetails" *ngIf="s.isSummary !== false">
        <div class="tw-bg-[#FFFFFF]">
          <div class="tw-bg-white tw-px-6 tw-pt-4 tw-rounded-xl tw-shadow-[0_6px_12px_rgba(0,0,0,0.3)]">
            <!-- Header + Chevron -->
            <div class="tw-flex tw-items-center tw-justify-between tw-cursor-pointer"
                (click)="s.open = !s.open">
              <label class="tw-text-lg tw-font-bold">
                {{ s.headerTitle }}
              </label>
              <app-icon name="chevron-down" [size]="14"
                [extraClass]="s.open ? 'tw-rotate-180 tw-transition-transform' : 'tw-transition-transform'">
              </app-icon>
            </div>

            <hr class="tw--mx-6 tw-mt-4" />

            <ng-container *ngIf="s.open">
              <!-- Screened By / Screening Date -->
              <div class="tw-grid tw-grid-cols-2 tw-gap-4 tw-my-4">
                <!-- Screened By -->
                <div>
                  <div class="tw-text-[13px] tw-font-medium">Screened By</div>
                  <input
                    class="tw-w-full tw-text-[14px] tw-mt-1 tw-rounded-md tw-border tw-border-gray-300 tw-px-3 tw-py-2 tw-bg-gray-100 tw-text-[#8b8b8b] tw-cursor-default"
                    [value]="s.hrUserName || sessionUserName || '—'"
                    disabled
                    title="Screened By"
                  />
                </div>

                <!-- Screening Date -->
                <div>
                  <div class="tw-text-[13px] tw-font-medium">Screening Date</div>
                  <div
                    class="tw-relative tw-mt-1"
                    (mousedown)="onDateBoxMouseDown(nativePicker)"
                    [ngClass]="isEditingScreened(s) ? 'tw-cursor-pointer' : ''"
                  >
                    <!-- visible box -->
                    <input
                      type="text"
                      class="tw-w-full tw-text-[14px] tw-rounded-md tw-border tw-border-gray-300 tw-px-3 tw-py-2 tw-pr-9"
                      [value]="isEditingScreened(s)
                        ? (formatDateDDMMYYYY(formDetails.get('dateInterviewReview')?.value) || 'DD/MM/YYYY')
                        : (s.stageDate | date:'dd/MM/yyyy')"
                      readonly
                      [ngClass]="!isEditingScreened(s) ? 'tw-text-[#8b8b8b] tw-bg-gray-100' : ''"
                      title="Screening Date"
                    />

                    <!-- calendar icon -->
                    <button
                      type="button"
                      class="tw-absolute tw-inset-y-0 tw-right-2 tw-flex tw-items-center tw-justify-center tw-w-6"
                      [disabled]="!isEditingScreened(s)"
                      (click)="openDatePicker(nativePicker)"
                      [ngClass]="isEditingScreened(s) ? 'tw-text-gray-600 hover:tw-text-black' : 'tw-text-gray-400 tw-cursor-not-allowed'"
                      aria-label="Open calendar"
                    >
                      <app-icon name="calendar-days" [size]="18"></app-icon>
                    </button>

                    <!-- hidden native date input -->
                    <input
                      #nativePicker
                      type="date"
                      class="tw-absolute tw-top-0 tw-left-0 tw-w-px tw-h-10 tw-opacity-0"
                      [min]="today"
                      formControlName="dateInterviewReview"
                      (change)="onNativeDateChanged()"
                      aria-hidden="true"
                      tabindex="0"
                    />
                  </div>
                </div>
              </div>

              <!-- Result -->
              <div class="tw-mb-4">
                <div class="tw-text-[13px] tw-font-medium">Result</div>
                <div class="tw-flex tw-flex-wrap tw-gap-2 tw-mt-1">
                  <button type="button"
                          *ngFor="let c of s.categories"
                          class="tw-text-sm tw-rounded-lg tw-px-3 tw-py-1.5 tw-border tw-transition"
                          [ngClass]="getCategoryBtnClass(c, s.selectedCategoryId)"
                          [disabled]="!isEditingScreened(s)"
                          (click)="isEditingScreened(s) ? onSelectCategory(s, c.categoryId) : null">
                    {{ c.categoryName }}
                  </button>
                </div>
              </div>

              <!-- Reason -->
              <div class="tw-mb-4" *ngIf="s.reasons?.length">
                <div class="tw-text-[13px] tw-font-medium">Reason</div>
                <div class="tw-grid md:tw-grid-cols-2 tw-gap-y-3 tw-gap-x-4 tw-mt-2">
                  <div class="tw-flex tw-items-start tw-gap-2"
                    *ngFor="let r of s.reasons; let ri = index"
                    (click)="isEditingScreened(s) ? toggleReason(s, ri) : null"
                    [class.tw-cursor-pointer]="isEditingScreened(s)"
                  >
                    <span
                      role="checkbox"
                      [attr.aria-checked]="r.checked"
                      class="tw-inline-flex tw-items-center tw-justify-center tw-rounded-[4px] tw-border tw-align-middle tw-mt-0.5"
                      [ngClass]="r.checked ? 'tw-border-green-500 tw-bg-green-50' : 'tw-border-gray-300 tw-bg-white'"
                      style="width:18px;height:18px;min-width:18px;min-height:18px">
                      <app-icon *ngIf="r.checked" name="check" [size]="14" class="tw-text-green-600"></app-icon>
                    </span>
                    <span class="tw-text-[14px]">{{ r.reasonText }}</span>
                  </div>
                </div>
              </div>

              <!-- Notes / Strength & Concern -->
              <div class="tw-space-y-3 tw-pb-4">
                <ng-container [ngSwitch]="s.stageNameNormalized">
                  <!-- Screened: Notes (editable when Pending + Edit mode) -->
                  <ng-container *ngSwitchCase="'screened'">
                    <!-- Notes -->
                    <div>
                      <div class="tw-text-[13px] tw-font-medium">Notes</div>
                      <textarea
                        class="tw-w-full tw-text-[14px] tw-h-32 tw-mt-1 tw-rounded-md tw-border tw-border-gray-300 tw-px-3 tw-py-2"
                        formControlName="noteInterviewReview"
                        [ngClass]="!isEditingScreened(s) ? 'tw-text-[#8b8b8b] tw-bg-gray-100 tw-cursor-default' : ''"
                        (input)="formDetails.get('noteInterviewReview')?.setValue(($any($event.target).value || '').trimStart())"
                      ></textarea>
                    </div>
                  </ng-container>

                  <ng-container *ngSwitchCase="'offered'">
                    <div>
                      <div class="tw-text-[13px] tw-font-medium">Notes</div>
                      <textarea
                        class="tw-w-full tw-text-[14px] tw-h-32 tw-mt-1 tw-rounded-md tw-border tw-border-gray-300 tw-px-3 tw-py-2 tw-bg-gray-100"
                        [value]="s.notes || '—'" disabled></textarea>
                    </div>
                  </ng-container>

                  <!-- Others: Strength & Concern -->
                  <ng-container *ngSwitchDefault>
                    <div>
                      <div class="tw-text-[13px] tw-font-medium">Strength</div>
                      <textarea
                        class="tw-w-full tw-text-[14px] tw-h-28 tw-mt-1 tw-rounded-md tw-border tw-border-gray-300 tw-px-3 tw-py-2 tw-bg-gray-100"
                        [value]="s.strength || '—'" disabled></textarea>
                    </div>
                    <div>
                      <div class="tw-text-[13px] tw-font-medium">Concern</div>
                      <textarea
                        class="tw-w-full tw-text-[14px] tw-h-28 tw-mt-1 tw-rounded-md tw-border tw-border-gray-300 tw-px-3 tw-py-2 tw-bg-gray-100"
                        [value]="s.concern || '—'" disabled></textarea>
                    </div>
                  </ng-container>
                </ng-container>
              </div>

              <!-- Actions: Edit / Confirm / Cancel -->
              <div *ngIf="s.stageNameNormalized==='screened' && (screening.status==='Pending' || allowEditButton || editReview)"
                  class="tw-flex tw-gap-3 tw-justify-end tw-pb-5">
                <button *ngIf="allowEditButton && !editReview" type="button" (click)="onEditReview(s)"
                        class="tw-rounded-lg tw-bg-[#00AAFF] tw-text-white tw-py-2 tw-px-4 tw-transition-all hover:tw-bg-[#0c95da]">
                  Edit
                </button>

                <ng-container *ngIf="editReview">
                  <button type="button" (click)="onConfirmReview(s)"
                          class="tw-rounded-lg tw-bg-[#D97706] tw-text-white tw-py-2 tw-px-4 tw-transition-all hover:tw-bg-[#c46b07]">
                    Confirm
                  </button>
                  <button type="button" (click)="onCancelReview()"
                          class="tw-rounded-lg tw-border tw-border-[#E5E5E5] tw-text-black tw-py-2 tw-px-4 tw-transition-all hover:tw-bg-[#E5E5E5]">
                    Cancel
                  </button>
                </ng-container>
              </div>
            </ng-container>
          </div>
        </div>
      </form>
    </section>

    <!-- ===== Comments ===== -->
    <section id="comments-section" class="tw-w-full">
      <div class="tw-bg-white tw-px-6 tw-pt-4 tw-rounded-xl tw-shadow-[0_6px_12px_rgba(0,0,0,0.3)]">
        <div class="tw-flex tw-items-center tw-justify-between">
          <label class="tw-text-lg tw-font-bold">Comments</label>
        </div>

        <hr class="tw--mx-6 tw-mt-4" />

        <!-- Loading -->
        <div *ngIf="commentsLoading" class="tw-text-sm tw-text-gray-500 tw-py-4">Loading comments...</div>

        <!-- List -->
        <div class="tw-space-y-6 tw-py-4" *ngIf="!commentsLoading && totalComments > 0">
          <ng-container
            *ngTemplateOutlet="renderCommentList; context: { $implicit: commentsTree, depth: 0 }">
          </ng-container>

          <ng-template #renderCommentList let-list let-depth="depth">
            <ng-container *ngFor="let c of list; trackBy: trackByCommentId">
              <div class="tw-flex tw-gap-3" [ngClass]="depth > 0 ? 'tw-border-l-2 tw-border-blue-100 tw-pl-3' : ''">
                <div class="tw-pt-1">
                  <app-icon name="comment-text" [size]="22"
                            [ngClass]="depth > 0 ? 'tw-text-gray-400' : 'tw-text-indigo-400'"></app-icon>
                </div>

                <div class="tw-flex-1">
                  <!-- Header -->
                  <div class="tw-text-[14px] tw-font-semibold"
                      [ngClass]="depth > 0 ? 'tw-text-[#0A57C3]' : 'tw-text-indigo-700'">
                    {{ c.author }}
                  </div>
                  <div class="tw-text-[12px] tw-text-gray-500 tw-flex tw-items-center tw-gap-2">
                    <span>{{ c.createdAt | date:'d MMMM yyyy h:mm a' }}</span>
                    <span *ngIf="c.commentType"
                          class="tw-inline-flex tw-items-center tw-px-2 tw-py-[2px] tw-rounded-md tw-text-[11px] tw-font-medium"
                          [ngClass]="depth > 0 ? 'tw-bg-gray-100 tw-text-gray-700' : 'tw-bg-indigo-50 tw-text-indigo-700'">
                      {{ c.commentType }}
                    </span>
                    <span *ngIf="isEditedAtSecond(c.createdAt, c.updatedAt)">· edited</span>
                  </div>

                  <!-- Content / Edit Mode -->
                  <div *ngIf="!c.ui.isEditing; else editBox" class="tw-mt-2">
                    <div class="tw-rounded-xl tw-px-4 tw-py-3 tw-text-[14px]"
                        [ngClass]="depth > 0 ? 'tw-bg-gray-100' : 'tw-bg-indigo-50 tw-border tw-border-indigo-100'">
                      {{ c.text }}
                    </div>
                  </div>

                  <ng-template #editBox>
                    <div class="tw-mt-2">
                      <textarea
                        class="tw-w-full tw-text-[14px] tw-min-h-[88px] tw-rounded-lg tw-border tw-border-gray-300 tw-px-3 tw-py-2 focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-blue-300"
                        [value]="c.ui.editText"
                        (input)="c.ui.editText = $any($event.target).value"
                      ></textarea>
                      <div class="tw-flex tw-items-center tw-gap-3 tw-mt-2">
                        <button type="button"
                                class="tw-bg-[#0A57C3] tw-text-white tw-text-[14px] tw-px-3 tw-py-1 tw-rounded-lg hover:tw-brightness-110"
                                (click)="onSaveEdit(c)">
                          Save
                        </button>
                        <button type="button"
                                class="tw-text-gray-600 tw-text-[14px] hover:tw-text-gray-800"
                                (click)="c.ui.isEditing = false">
                          Cancel
                        </button>
                      </div>
                    </div>
                  </ng-template>

                  <!-- Actions -->
                  <div class="tw-flex tw-items-center tw-gap-3 tw-pt-2">
                    <button type="button"
                            class="tw-text-[13px] tw-inline-flex tw-items-center tw-gap-1 tw-rounded-md tw-border tw-border-indigo-200 tw-bg-indigo-50 tw-text-indigo-700 hover:tw-bg-indigo-100 hover:tw-border-indigo-300 focus:tw-ring-2 focus:tw-ring-indigo-200 focus:tw-outline-none tw-px-2 tw-py-0.5"
                            *ngIf="depth === 0"
                            (click)="toggleReply(c)">
                      Reply
                    </button>

                    <button type="button"
                            class="tw-text-[13px] tw-text-[#D97706] hover:tw-text-[#a7671e] tw-inline-flex tw-items-center tw-gap-1"
                            *ngIf="c.isEdited"
                            (click)="startEdit(c)">
                      <app-icon name="pen-to-square" [size]="20"></app-icon><span>Edit</span>
                    </button>

                    <button type="button"
                            class="tw-text-[13px] tw-text-[#F00] hover:tw-text-[#AA0000] tw-inline-flex tw-items-center tw-gap-1"
                            *ngIf="c.canDelete"
                            (click)="onDeleteComment(c)">
                      <app-icon name="trash" [size]="20"></app-icon><span>Delete</span>
                    </button>
                  </div>

                  <!-- Reply Box -->
                  <div *ngIf="c.ui.isReplying" class="tw-mt-3">
                    <textarea
                      class="tw-w-full tw-text-[14px] tw-min-h-[88px] tw-rounded-lg tw-border tw-border-gray-300 tw-px-3 tw-py-2 focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-blue-300"
                      placeholder="Write a reply..."
                      [value]="c.ui.replyText"
                      (input)="c.ui.replyText = $any($event.target).value"
                    ></textarea>
                    <div class="tw-flex tw-items-center tw-gap-3 tw-mt-2">
                      <button type="button"
                              class="tw-bg-indigo-600 tw-text-white tw-text-[14px] tw-px-3 tw-py-1 tw-rounded-lg hover:tw-bg-indigo-700 focus:tw-ring-2 focus:tw-ring-indigo-200"
                              (click)="onSubmitReply(c)">
                        Reply
                      </button>
                      <button type="button"
                              class="tw-text-gray-600 tw-text-[14px] hover:tw-text-gray-800"
                              (click)="c.ui.isReplying = false">
                        Cancel
                      </button>
                    </div>
                  </div>

                  <!-- Children -->
                  <div class="tw-ml-10 tw-mt-4" *ngIf="c.replies?.length">
                    <ng-container
                      *ngTemplateOutlet="renderCommentList; context: { $implicit: c.replies, depth: depth + 1 }">
                    </ng-container>
                  </div>
                </div>
              </div>
            </ng-container>
          </ng-template>
        </div>

        <hr class="tw--mx-6" *ngIf="totalComments > 0" />

        <!-- Composer -->
        <div class="tw-py-4">
          <div class="tw-text-[14px] tw-font-semibold tw-text-[#0A57C3]">
            {{ currentUserName || 'You' }}
          </div>
          <div class="tw-mt-2">
            <textarea
              class="tw-w-full tw-text-[14px] tw-min-h-[96px] tw-rounded-lg tw-border tw-border-gray-300 tw-px-3 tw-py-2 focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-blue-300"
              placeholder="Write a comment..."
              [formControl]="commentCtrl"
            ></textarea>
          </div>
          <div class="tw-flex tw-items-center tw-justify-end tw-gap-4 tw-mt-3">
            <button type="button"
                    class="tw-text-[15px] tw-text-gray-600 hover:tw-text-gray-800"
                    (click)="commentCtrl.setValue('')">
              Cancel
            </button>
            <button
              type="button"
              class="tw-inline-flex tw-items-center tw-gap-2 tw-bg-[#0A57C3] tw-text-white tw-text-[15px] tw-px-4 tw-py-2 tw-rounded-lg hover:tw-brightness-110"
              (click)="onSubmitNewComment()"
            >
              <app-icon name="comment-text" [size]="18" class="tw-shrink-0"></app-icon>
              <span class="tw-leading-none">Comment</span>
            </button>
          </div>
        </div>
      </div>
    </section>
    <!-- /Comments -->

  </div>

  <!-- =============== RIGHT (1 col) =============== -->
  <aside class="tw-col-span-1 tw-space-y-6">
    <!-- Card: Application Screening -->
    <button
      type="button"
      [disabled]="true"
      class="tw-w-full tw-rounded-2xl tw-text-white tw-px-6 tw-py-6 tw-text-left tw-shadow-[0_8px_16px_rgba(0,0,0,0.25)] tw-transition-all tw-duration-200 tw-ease-in-out hover:tw-brightness-110 hover:tw-shadow-[0_12px_20px_rgba(0,0,0,0.35)] focus:tw-ring-2 focus:tw-ring-white/30 tw-cursor-default tw-pointer-events-none"
      [style.backgroundColor]="screeningCardBg"
      (click)="onScreeningCardClick()"
    >
      <div class="tw-flex tw-items-center tw-gap-6">
        <app-icon name="user" [size]="48" class="tw-opacity-90"></app-icon>
        <div class="tw-flex-1">
          <div class="tw-text-[14px] tw-opacity-90">
            Application Screening<br />
            by {{ screening.screenedBy || "—" }} on
            {{ screening.screeningDate | date : "dd MMMM yyyy" }}
          </div>
          <div class="tw-text-[24px] tw-font-bold leading-none">
            {{ screening.status || "—" }}
          </div>
        </div>
      </div>
    </button>

    <!-- Card: Application Form Submitted (Blue) -->
    <button
      type="button"
      class="tw-w-full tw-rounded-2xl tw-bg-[#0A57C3] tw-text-white tw-px-6 tw-py-6 tw-text-left tw-shadow-[0_8px_16px_rgba(0,0,0,0.25)] tw-transition-all tw-duration-200 tw-ease-in-out hover:tw-brightness-110 hover:tw-shadow-[0_12px_20px_rgba(0,0,0,0.35)] focus:tw-ring-2 focus:tw-ring-white/30"
      (click)="onViewDetailClick()"
    >
      <div class="tw-flex tw-items-center tw-gap-6">
        <app-icon
          name="certificate-badge"
          [size]="48"
          class="tw-opacity-90"
        ></app-icon>
        <div class="tw-flex-1">
          <div class="tw-text-[14px] tw-opacity-95">
            Application Form Submitted
          </div>
          <div class="tw-text-[14px] tw-opacity-90">
            on {{ applicationFormSubmittedDate | date : "dd MMMM yyyy" }}
          </div>
          <div class="tw-text-[24px] tw-font-bold leading-none">
            View Detail
          </div>
        </div>
      </div>
    </button>

    <!-- Card: Comment (Purple) -->
    <button
      type="button"
      class="tw-w-full tw-rounded-2xl tw-bg-[#5500FF] tw-text-white tw-px-6 tw-py-6 tw-text-left tw-shadow-[0_8px_16px_rgba(0,0,0,0.25)] tw-transition-all tw-duration-200 tw-ease-in-out hover:tw-brightness-110 hover:tw-shadow-[0_12px_20px_rgba(0,0,0,0.35)] focus:tw-ring-2 focus:tw-ring-white/30"
      (click)="onCommentClick()"
    >
      <div class="tw-flex tw-items-center tw-gap-6">
        <app-icon
          name="comment-text"
          [size]="48"
          class="tw-opacity-90"
        ></app-icon>
        <div class="tw-flex-1">
          <div class="tw-text-[14px] tw-opacity-95">
            {{ totalComments }}
            {{ totalComments === 1 ? "comment" : "comments" }}
          </div>
          <div class="tw-text-[24px] tw-font-bold leading-none">
            Comment
          </div>
        </div>
      </div>
    </button>

    <!-- Card: Transcript -->
    <section id="transcript-section" class="tw-w-full">
      <div class="tw-bg-white tw-px-6 tw-pt-4 tw-rounded-xl tw-shadow-[0_6px_12px_rgba(0,0,0,0.3)]">
        <div class="tw-flex tw-items-center tw-justify-between">
          <label class="tw-text-lg tw-font-bold">Transcript</label>
        </div>

        <hr class="tw--mx-6 tw-mt-4" />

        <div class="tw-py-6">
          <ng-container *ngIf="(transcripts?.length || 0) > 0; else noTranscripts">
            <ul class="tw-space-y-3">
              <li *ngFor="let t of transcripts; trackBy: trackByFileName" class="tw-text-[14px]">
                <button type="button"
                  class="tw-text-inherit hover:tw-underline tw-text-left"
                  (click)="openAttachment(t)">
                  {{ t.name }}
                </button>
              </li>
            </ul>
          </ng-container>
          <ng-template #noTranscripts>
            <div class="tw-text-[14px] tw-text-gray-500">—</div>
          </ng-template>
        </div>
      </div>
    </section>

    <!-- Card: Certifications -->
    <section id="certifications-section" class="tw-w-full">
      <div class="tw-bg-white tw-px-6 tw-pt-4 tw-rounded-xl tw-shadow-[0_6px_12px_rgba(0,0,0,0.3)]">
        <div class="tw-flex tw-items-center tw-justify-between">
          <label class="tw-text-lg tw-font-bold">Certifications</label>
        </div>

        <hr class="tw--mx-6 tw-mt-4" />

        <div class="tw-py-6">
          <ng-container *ngIf="(certifications?.length || 0) > 0; else noCerts">
            <ul class="tw-space-y-3">
              <li *ngFor="let c of certifications; trackBy: trackByFileName" class="tw-text-[14px]">
                <button type="button"
                  class="tw-text-inherit hover:tw-underline tw-text-left"
                  (click)="openAttachment(c)">
                  {{ c.name }}
                </button>
              </li>
            </ul>
          </ng-container>
          <ng-template #noCerts>
            <div class="tw-text-[14px] tw-text-gray-500">—</div>
          </ng-template>
        </div>
      </div>
    </section>

    <!-- Card: History Log -->
    <section id="history-log-section" class="tw-w-full">
      <div class="tw-bg-white tw-px-6 tw-pt-4 tw-rounded-xl tw-shadow-[0_6px_12px_rgba(0,0,0,0.3)]">
        <div class="tw-flex tw-items-center tw-justify-between">
          <label class="tw-text-lg tw-font-bold">History Log</label>
        </div>

        <hr class="tw--mx-6 tw-mt-4" />

        <div class="tw-py-6">
          <ng-container *ngIf="(historyLogs?.length || 0) > 0; else noHistory">
            <ul class="tw-space-y-3">
              <li *ngFor="let h of historyLogs; trackBy: trackByHistory"
                  class="tw-text-[14px] tw-grid tw-grid-cols-[132px_1fr] tw-gap-x-2">
                <span class="tw-text-gray-600">
                  {{ h.date | date:'dd/MM/yyyy  HH:mm' }}
                </span>
                <span class="tw-text-gray-800">
                  {{ h.action }}
                </span>
              </li>
            </ul>
          </ng-container>
          <ng-template #noHistory>
            <div class="tw-text-[14px] tw-text-gray-500">—</div>
          </ng-template>
        </div>
      </div>
    </section>

  </aside>
</div>

<!-- Floating Back-to-Top -->
<app-back-to-top
  [sentinelSelector]="'#page-top-sentinel'"
  [buttonClass]="'tw-fixed tw-bottom-6 tw-right-6 tw-rounded-full tw-h-14 tw-w-14 tw-flex tw-items-center tw-justify-center tw-shadow-xl bg-red-blood hover:bg-maroon-1 tw-text-white tw-z-[60]'"
  [iconName]="'arrow-upward'"
  [iconSize]="26">
</app-back-to-top>
